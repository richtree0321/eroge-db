# 高速検索・表示を実現するデータベース設計案 (不動産サイト風)

「賃貸検索サイトのような、条件を細かく指定できて、かつ爆速なサイト」を作るための最適なデータベース設計を提案します。

## 結論：ハイブリッド構成（検索用 + 表示用）

**「検索はリレーショナル（または配列）」**、**「表示は JSON」** と役割を分けるのが、速度と開発しやすさのベストバランスです。

---

## 1. なぜ「ハイブリッド」なのか？

| 方式                       | 検索速度 (複雑な条件) | 表示速度 (一覧表示) | 解説                                                                                                       |
| :------------------------- | :-------------------- | :------------------ | :--------------------------------------------------------------------------------------------------------- |
| **A. フル JSONB (現状)**   | ❌ 遅い               | ⭕ 早い             | 「タグ A かつタグ B」のような条件が増えるとインデックスが効きにくく、全データ走査になりがち。              |
| **B. フル正規化 (ダンプ)** | ⭕ 早い               | 🔺 少し重い         | 検索は早いが、一覧画面で「画像、タイトル、タグ」を出すために毎回 10 個のテーブルを結合(JOIN)するのは無駄。 |
| **C. ハイブリッド (推奨)** | **◎ 爆速**            | **◎ 爆速**          | **検索に必要な項目だけ** 列として取り出し、**表示用データ** は JSON で持っておく。                         |

---

## 2. 具体的なテーブル設計イメージ

`visual_novels` テーブルを以下のように改造（または新設）します。

```sql
CREATE TABLE search_optimized_vns (
    -- ▼▼ 検索用カラム (インデックスを貼る) ▼▼
    id VARCHAR(20) PRIMARY KEY,
    title TEXT,                    -- タイトル検索用
    searchable_title TEXT,         -- 検索用（ひらがな化など）

    -- 数値フィルタ用 (範囲検索に強い)
    rating INTEGER,                -- 評価点 (例: 85)
    released_date DATE,            -- 発売日
    height_votes INTEGER,          -- 人気順ソート用

    -- タグ検索用 (GINインデックスが最強に効く形)
    -- タグIDを整数の配列として持つ (例: {10, 25, 40})
    tag_ids INTEGER[],

    -- ブランド・属性フィルタ用
    developer_id INTEGER,
    original_language VARCHAR(5),

    -- ▼▼ 表示用カラム (JOIN不要で爆速表示) ▼▼
    -- 画面表示に必要な「完成されたデータ」をそのまま入れておく
    display_payload JSONB
);

-- インデックス作成 (これで爆速になります)
CREATE INDEX idx_rating ON search_optimized_vns (rating);
CREATE INDEX idx_released ON search_optimized_vns (released_date);
CREATE INDEX idx_tag_ids ON search_optimized_vns USING GIN (tag_ids); -- ← これが「賃貸サイト風検索」のキモ
```

### この設計のメリット

1.  **「タグ検索」が速い**:

    - JSON の中の文字列を探すのではなく、`tag_ids` という数字の配列から探すので、PostgreSQL の GIN インデックスがフルパワーを発揮します。
    - `WHERE tag_ids @> '{10, 25}'` (タグ 10 と 25 の両方を含む) というクエリが一瞬で終わります。

2.  **「複合条件」に強い**:

    - 「2020 年以降発売」かつ「評価 80 点以上」かつ「タグ：学園」のような検索は、個別のカラムのインデックスが組み合わさって高速に動作します。

3.  **「表示」も速い**:
    - 検索結果が出たら、あとは `display_payload` の中身をそのままフロントエンドに返すだけ。複雑な JOIN 処理は不要です。

---

## 3. 実現するためのステップ

1.  **データインポート (Import)**:
    - VNDB ダンプ (`vndb_raw` DB) を入れる。
2.  **データ変換 (ETL)**:
    - `vndb_raw` からデータを読み出し、
    - 検索用カラム (`tag_ids` 等) を抽出し、
    - 表示用 JSON (`display_payload`) を組み立て、
    - `search_optimized_vns` テーブルに保存するプログラムを作る。
3.  **アプリ開発**:
    - Next.js からは `search_optimized_vns` テーブルだけを見る。

まさに「賃貸サイト」が裏でやっているような、**「検索に特化した形」** でデータを持つことが成功の鍵です。
