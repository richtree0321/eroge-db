# 今後の開発で「躓きやすいポイント」と対策ガイド

プロジェクトがスケール（規模拡大）し、高機能化していく過程で直面するであろう「壁」を、インフラ・バックエンド・フロントエンド・運用面の各視点からまとめました。
転ばぬ先の杖として活用してください。

## 1. データベース・バックエンドの壁

### 🚧 JSONB 型のパフォーマンスと検索の限界

現在、タグや開発者情報を `JSONB` 型で保存していますが、データが数千・数万件になると「タグ検索」が重くなります。

- **躓きポイント**: `tags @> '[{"name": "School"}]'` のような検索は、適切なインデックスがないと全件スキャンになり、応答が秒単位で遅れます。
- **対策**: PostgreSQL の `GIN Index` を作成する。あるいは、検索機能が本格化する段階で、正規化（`tags` テーブルと `vn_tags` 中間テーブルへの分割）を検討する（RDB 本来の形）。

### 🚧 外部 API (VNDB) との同期ズレ

- **躓きポイント**: VNDB 側のデータが更新されたり、タグ ID が変わったりした場合、こちらの DB の情報が古くなります。
- **対策**:
  - 「差分更新」の仕組みを作る（`updated_at` を見て新しいものだけ取得するなど）。
  - 定期実行バッチ（Cron/Systemd timer）の実装。

## 2. フロントエンド (Next.js) の壁

### 🚧 Server Components vs Client Components の混乱

- **躓きポイント**: 「ボタンを押したら動く」機能（検索バー、ページネーション、いいねボタン）を作る際、`useState` や `onClick` を使うには `'use client'` が必要です。しかし、SEO やパフォーマンスのために Server Component も維持したい…という境界線の設計で悩みます。
- **対策**: 「末端のインタラクティブな部分だけ」を Client Component として切り出す設計パターン（Leaf Component）を意識する。

### 🚧 画像の最適化とコスト

- **躓きポイント**: 今は VNDB の画像を直接参照あるいはローカル保存かもしれませんが、アクセスが増えると転送量が増大します。また、VNDB への直リンクは相手サーバーへの負荷になるため、マナー違反やブロックの対象になります。
- **対策**:
  - 画像を自サーバーに保存し、Next.js の `<Image />` コンポーネントで最適化して配信する。
  - 将来的には、S3 などのオブジェクトストレージ + CloudFront (CDN) の導入が必要になる（課金ポイント）。

## 3. インフラ・デプロイの壁 (ここが一番大変です！)

### 🚧 「ローカルでは動くのに」問題

- **躓きポイント**: WSL(Ubuntu)と本番環境(AWS Linux)の違い、ネットワーク設定、環境変数の設定漏れなどで、デプロイ時に必ず一度は失敗します。
- **対策**: Docker を徹底活用する。本番でも Docker Compose で動かせば、環境差異は最小限になります。

### 🚧 HTTPS 化 (SSL 証明書)

- **躓きポイント**: 今は `http://` ですが、Web 公開には `https://` が必須です。証明書の取得と更新（Let's Encrypt）の自動化設定でハマりやすいです。
- **対策**: 前段に `Nginx` コンテナを置き、リバースプロキシ設定を行う構成を学ぶ必要があります。

### 🚧 データベースのバックアップ

- **躓きポイント**: コンテナを消してしまったり、誤った `UPDATE` 文でデータを壊した後、「バックアップがない」ことに気づきます。
- **対策**: スクリプトで定期的に `pg_dump` を実行し、S3 や別の場所に保存する仕組みを早い段階で作る。

## 4. アダルトコンテンツ特有の「最大の壁」

### 🚧 収益化と決済の排除

- **躓きポイント**: 一般的なアフィリエイトサービス（ASP）や広告ネットワーク（Google AdSense 等）、決済代行会社（Stripe, PayPal）は、**アダルトコンテンツを厳しく禁止**しています。アカウントが突然凍結されるリスクがあります。
- **対策**:
  - アダルト OK な ASP（FANZA, DLsite など）を利用する。
  - サーバー選びも重要（AWS は規約上 OK ですが、他のレンタルサーバーは NG な場合が多い）。

---

## 5. 成長ロードマップごとの推奨アクション

### フェーズ 1: 機能拡充期（今ここ）

- [ ] **リファクタリング**: `page.tsx` に全部書かず、Component を分割する。
- [ ] **型定義**: `any` を絶対に使わない方針を徹底する。

### フェーズ 2: 本番公開直前

- [ ] **Nginx 導入**: Next.js の前に Nginx を置く（SSL 終端、静的ファイルキャッシュ）。
- [ ] **エラー監視**: Sentry 等のツールを入れ、ユーザー側で起きたエラーを検知できるようにする。

### フェーズ 3: 運用開始後

- [ ] **CI/CD**: GitHub に Push したら自動でテスト＆デプロイされる仕組み。
