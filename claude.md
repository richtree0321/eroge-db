# claude.md - Claude Code 用プロジェクトガイド

## 👤 私について

私はプログラミング学習中の**初学者**です。以下のルールを必ず守ってください：

### コーディングルール

1. **コードには必ず日本語コメントを付ける**

   - 各行ごとに、その行が何をしているか説明するコメントを添えてください
   - 特に複雑な処理には「なぜそう書くのか」の理由も説明してください

2. **専門用語は説明を添える**

   - 専門用語を使う場合は、括弧書きで簡単な説明を添えてください
   - 例: GIN インデックス（データベースの高速検索を可能にする目次機能）

3. **エラー発生時の対応**
   - まず何が起きたかを簡潔に説明する
   - その後で解決方法を提示する
   - 推測で進めず、わからない場合は質問してください

---

## 📁 プロジェクト概要

**プロジェクト名**: eroge-db（エロゲデータベース）

**目的**:

- VNDB のダンプデータを活用した「不動産サイトのような爆速検索」の実現
- プログラミング学習（特に Next.js/PostgreSQL のパフォーマンスチューニング）

**現在の進捗** (2026-01-11 時点):

- 一覧ページ・詳細ページが動作中
- 約 6 万作品のデータをインポート済み
- GIN インデックスによる高速検索を実装済み

---

## 🛠️ 技術スタック

| カテゴリ         | 技術                                                    |
| ---------------- | ------------------------------------------------------- |
| OS               | Windows 11 + WSL2 (Ubuntu)                              |
| フロントエンド   | Next.js 16.1.1 (App Router) + TypeScript + Tailwind CSS |
| データベース     | PostgreSQL 15 (Docker Compose)                          |
| バックエンド補助 | Python 3.x                                              |
| インフラ         | Docker / Docker Compose                                 |

### バックエンド方針（パフォーマンス重視）

**新しいバックエンド処理は Next.js で書く**（Python は使わない）

理由：

1. **余計な通信が不要**: Next.js → DB に直接アクセスできる（Python を挟むと遅くなる）
2. **高速化機能が豊富**: Server Components、キャッシュ、Streaming が標準装備
3. **TypeScript 統一**: 型定義を共有でき、学習効率が上がる

※既存の Python スクリプト（データ取り込み用）はそのまま維持

---

## 📂 ディレクトリ構造

```
eroge-db/
├── frontend/              # Next.js フロントエンド
│   ├── app/              # App Router のページコンポーネント
│   ├── lib/              # 共通ライブラリ（types.ts など）
│   └── public/           # 静的ファイル
├── context/              # プロジェクトドキュメント（詳細は下記参照）
├── .agent/workflows/     # 開発ワークフロー定義
├── docker-compose.yml    # Docker構成
├── ingest_vndb_data.py   # VNDBデータ取り込みスクリプト
└── vndb-db-2026-01-10/   # VNDBダンプデータ
```

---

## 📚 重要なコンテキストファイル

詳細情報が必要な場合は、以下のファイルを参照してください：

| ファイル                              | 内容                                               |
| ------------------------------------- | -------------------------------------------------- |
| `context/PROJECT_CONTEXT.md`          | プロジェクト全体の概要、現在の進捗、次のステップ   |
| `context/DB_STRUCTURE_EXPLANATION.md` | データベース構造の解説（GIN インデックス、正規化） |
| `context/DEVELOPMENT_HISTORY.md`      | 開発の履歴とマイルストーン                         |
| `context/FUTURE_CHALLENGES.md`        | 今後の課題と計画                                   |

---

## 🗄️ データベース構造

### 2 つのスキーマ構成（CQRS パターン）

1. **`public.search_vns`**: 高速検索用（非正規化）

   - 一覧表示に使用
   - `tag_ids` カラム + GIN インデックスで高速タグ検索

2. **`vndb.*`**: 詳細表示用（正規化・公式ダンプ）
   - 詳細ページで JOIN して使用
   - 主要テーブル: `vn`, `vn_titles`, `tags`, `tags_vn`, `chars`, `vn_staff` など

---

## 🚀 開発環境の起動

### 1. Docker コンテナ起動

```bash
cd /home/rich/eroge-db
docker compose up -d
```

### 2. フロントエンド起動

```bash
cd /home/rich/eroge-db/frontend
npm run dev -- -H 0.0.0.0
```

### 3. ブラウザアクセス

```
http://localhost:3000
```

※ ワークフロー `/start-dev` を実行すると、上記を自動チェックできます。

---

## ✅ コーディング規約

### TypeScript/JavaScript

- 変数名は意味がわかりやすい名前にする
- 関数は 1 つの機能に絞る（単一責任の原則）
- マジックナンバー（意味不明な数字）は避けて定数を使う
- 型定義は `lib/types.ts` に集約

### SQL

- 複雑なクエリにはコメントで意図を説明
- パフォーマンスに影響するクエリには `EXPLAIN ANALYZE` で確認

---

## 🚫 禁止事項（ガードレール）

### Next.js

- **App Router 以外に戻さない**: Pages Router は使用禁止
- **不要な `"use client"` を付けない**: Server Component を優先する
- **環境変数のハードコード禁止**: `.env.local` を使用する
- **CSS の散乱禁止**: Tailwind CSS で統一する

### データベース

- **vndb スキーマを変更しない**: 公式ダンプのテーブル構造は絶対に変更禁止
- **テーブル追加前に確認**: 新しいテーブルを追加する前に必ず提案して私の確認を取る
- **自前データは分離**: 自分で追加するデータは `public` スキーマに置く（元データを汚さない）
- **インデックスを意識**: 検索に使うカラムにはインデックスを検討する

### 一般

- **推測で進めない**: わからないことがあれば必ず質問する
- **大きな変更前に提案**: 複数ファイルにまたがる変更は、先に計画を説明する

---

## 🎯 次のマイルストーン (Milestone 4: Search UI)

1. 高度な検索 UI の実装（タグ絞り込み、評価スライダー）
2. ページネーション
3. ソート機能の実装

---

## ⚠️ 注意事項

- WSL 環境では `localhost` を使用（`192.168.x.x` ではなく）
- 画像 URL は VNDB のバケット計算（`id % 100`）を使用
- フロントエンドの変更後はブラウザをリロードして確認
